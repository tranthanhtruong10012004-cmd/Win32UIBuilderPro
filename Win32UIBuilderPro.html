<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Win32 UI Builder Pro v7.7.0</title>
<style>
:root {
  --bg:#f5f5f5;--panel:#fff;--text:#222;
  --border:#ccc;--accent:#0078D7;--control-bg:#fafafa;
}
body.dark {
  --bg:#1e1e1e;--panel:#252526;--text:#f5f5f5;
  --border:#555;--accent:#3794ff;--control-bg:#2a2a2a;
}
body{
  margin:0;font-family:"Segoe UI",sans-serif;
  background:var(--bg);color:var(--text);
  display:flex;flex-direction:column;height:100vh;overflow:hidden;
}
/* ===== title & toolbar ===== */
#titlebar{
  background:var(--accent);color:#fff;
  padding:8px 16px;display:flex;
  justify-content:space-between;align-items:center;
}
#toolbar{
  background:var(--panel);
  border-bottom:1px solid var(--border);
  display:flex;flex-wrap:wrap;gap:6px;padding:6px 8px;
}
#toolbar button,#toolbar select{
  padding:6px 10px;border:1px solid var(--border);
  background:var(--control-bg);cursor:pointer;
  border-radius:4px;font-size:13px;
}
#toolbar button:hover{background:var(--accent);color:#fff;}
#workspace{flex:1;display:flex;overflow:hidden;}
/* ===== canvas ===== */
#canvasWrapper{flex:1;overflow:scroll;background:var(--panel);
  cursor:grab;position:relative;}
#canvas{
  position:absolute;width:8000px;height:8000px;
  background-size:10px 10px;
  background-image:
   linear-gradient(to right,var(--border)1px,transparent 1px),
   linear-gradient(to bottom,var(--border)1px,transparent 1px);
}
.axis{position:absolute;background:red;z-index:1;}
#axisX{height:1px;width:8000px;top:4000px;left:0;}
#axisY{width:1px;height:8000px;left:4000px;top:0;}
/* ===== controls ===== */
.control{
  position:absolute;border:1px solid var(--accent);
  background:var(--control-bg);color:var(--text);
  text-align:center;font-size:12px;border-radius:4px;
  cursor:move;user-select:none;
  box-shadow:0 1px 2px rgba(0,0,0,.1);
  transition:box-shadow .2s,background .2s;
}
.control.selected{box-shadow:0 0 10px var(--accent);background:#e7f1ff;}
.control.locked{border:1px dotted var(--accent);cursor:not-allowed;opacity:.9;}
/* m√¥ ph·ªèng control th·∫≠t */
.ctrl-Button{padding-top:4px;background:linear-gradient(#fafafa,#dcdcdc);}
.ctrl-Button:active{background:linear-gradient(#dcdcdc,#fafafa);}
.ctrl-Edit{border:1px solid var(--border);text-align:left;padding:2px 4px;}
.ctrl-ComboBox{display:flex;justify-content:space-between;align-items:center;
  border:1px solid var(--border);padding:0 4px;}
.ctrl-ComboBox::after{content:"‚ñº";font-size:10px;}
.ctrl-ListBox{border:1px solid var(--border);text-align:left;overflow:hidden;}
.ctrl-ListBox div{padding:2px 4px;border-bottom:1px solid var(--border);}
.ctrl-ListBox::-webkit-scrollbar{width:6px;}
/* ===== property panel ===== */
#propertyPanel{
  width:260px;background:var(--panel);
  border-left:1px solid var(--border);
  padding:8px;overflow-y:auto;
}
#propertyPanel h3{margin:0 0 8px;border-bottom:1px solid var(--border);padding-bottom:4px;}
.property{margin-bottom:8px;}
.property label{font-size:12px;display:block;margin-bottom:3px;}
.property input{width:100%;font-size:12px;padding:3px;
  border:1px solid var(--border);border-radius:3px;
  background:var(--control-bg);color:var(--text);}
#stylePopup{
  position:absolute;z-index:100;background:var(--panel);
  border:1px solid var(--border);border-radius:6px;
  padding:8px;width:230px;max-height:300px;overflow:auto;
  display:none;box-shadow:0 2px 8px rgba(0,0,0,.2);
}
#stylePopup h4{margin:6px 0 4px;font-size:12px;border-bottom:1px solid var(--border);}
#codePreview{
  background:var(--panel);color:var(--text);
  font-family:Consolas,monospace;font-size:12px;
  border-top:1px solid var(--border);
  padding:10px;height:200px;overflow:auto;white-space:pre;
}
.combo-dropdown { font-size:12px; box-shadow:0 2px 4px rgba(0,0,0,.2); }

</style>
</head>
<body>
<div id="titlebar">
  <span>Win32 UI Builder Pro v7.7.0</span>
  <button id="themeToggle">üåô Dark</button>
</div>

<div id="toolbar">
  <select id="controlSelect">
    <option value="">‚ûï Th√™m Control</option>
    <option>MainForm</option><option>Button</option><option>Edit</option>
    <option>Static</option><option>ComboBox</option><option>ListBox</option>
    <option>CheckBox</option><option>RadioButton</option><option>GroupBox</option>
    <option>TreeView</option><option>ListView</option><option>ProgressBar</option>
    <option>DateTimePicker</option><option>TabControl</option><option>TabPage</option>
    <option>SysLink</option><option>CustomControl</option>
  </select>
  <button id="removeBtn">üóë X√≥a</button>
  <button id="undoBtn">üîÅ Undo</button>
  <button id="clearBtn">üßπ X√≥a t·∫•t c·∫£</button>
  <button id="lockBtn">üîí Kh√≥a thi·∫øt k·∫ø</button>
  <button id="saveBtn">üíæ L∆∞u layout</button>
  <button id="loadBtn">üìÇ N·∫°p layout</button>

  <select id="exportLang">
  <option value="cpp">C++ (Win32)</option>
  <option value="c">C (WinAPI)</option>
  <option value="python">Python (Tkinter)</option>
  <option value="json">JSON Layout</option>
</select>
    <button id="exportBtn">üì§ Xu·∫•t Code</button>
</div>

<div id="workspace">
  <div id="canvasWrapper">
    <div id="canvas">
 
    </div>
  </div>
  <div id="propertyPanel">
    <h3>Thu·ªôc t√≠nh</h3>
    <div id="propertyContent">Ch·ªçn control ƒë·ªÉ ch·ªânh</div>
  </div>
</div>

<div id="codePreview">// Code s·∫Ω hi·ªán ·ªü ƒë√¢y...</div>
<div id="stylePopup"></div>
<script>
// ==============================
// ‚öôÔ∏è CORE LOGIC ‚Äì Win32UIBuilderPro v7.7.3
// ==============================
const canvasWrapper=document.getElementById("canvasWrapper");
const canvas=document.getElementById("canvas");
const propertyContent=document.getElementById("propertyContent");
const controlSelect=document.getElementById("controlSelect");
const themeToggle=document.getElementById("themeToggle");
const codePreview=document.getElementById("codePreview");
const stylePopup=document.getElementById("stylePopup");
const lockBtn=document.getElementById("lockBtn");

let selectedControl=null,isDragging=false,offsetX=0,offsetY=0;
let lockedDesign=false;
const undoStack=[],MAX_UNDO=8;
const CENTER=4000; // t√¢m canvas (0,0)

// üåô Theme toggle
themeToggle.onclick=()=>{
  document.body.classList.toggle("dark");
  const dark=document.body.classList.contains("dark");
  themeToggle.textContent=dark?"‚òÄÔ∏è Light":"üåô Dark";
  localStorage.setItem("theme",dark?"dark":"light");
};
window.addEventListener("load",()=>{
  if(localStorage.getItem("theme")==="dark"){
    document.body.classList.add("dark");
    themeToggle.textContent="‚òÄÔ∏è Light";
  }
  canvasWrapper.scrollLeft=CENTER-canvasWrapper.clientWidth/2;
  canvasWrapper.scrollTop=CENTER-canvasWrapper.clientHeight/2;
});

// üîí Lock thi·∫øt k·∫ø
lockBtn.onclick=()=>{
  lockedDesign=!lockedDesign;
  lockBtn.textContent=lockedDesign?"üîì M·ªü kh√≥a":"üîí Kh√≥a thi·∫øt k·∫ø";
  document.querySelectorAll(".control").forEach(c=>{
    c.classList.toggle("locked",lockedDesign);
    c.style.pointerEvents=lockedDesign?"none":"auto";
  });
};

// ‚ûï Th√™m control
controlSelect.onchange=()=>{
  const type=controlSelect.value;if(!type)return;
  addControl(type);controlSelect.value="";
};
function addControl(type, data = null) {
  let el;

  // üé® T·∫°o control th·∫≠t t∆∞∆°ng ·ª©ng v·ªõi Win32
  switch (type) {
    case "Button":
      el = document.createElement("button");
      el.textContent = data?.caption || "Button";
      break;

    case "CheckBox":
      el = document.createElement("input");
      el.type = "checkbox";
      el.style.width = "16px";
      el.style.height = "16px";
      break;

    case "RadioButton":
      el = document.createElement("input");
      el.type = "radio";
      el.style.width = "16px";
      el.style.height = "16px";
      break;

    case "Edit":
      el = document.createElement("input");
      el.type = "text";
      el.value = data?.caption || "Edit text";
      break;

    case "Static":
      el = document.createElement("label");
      el.textContent = data?.caption || "Static";
      break;

    case "ComboBox":
      el = document.createElement("select");
      for (let i = 1; i <= 5; i++) {
        const o = document.createElement("option");
        o.textContent = "Item " + i;
        el.appendChild(o);
      }
      break;

    case "ListBox":
      el = document.createElement("select");
      el.multiple = true;
      for (let i = 1; i <= 10; i++) {
        const o = document.createElement("option");
        o.textContent = "Item " + i;
        el.appendChild(o);
      }
      el.size = 5;
      break;

    case "ProgressBar":
      el = document.createElement("progress");
      el.value = 30;
      el.max = 100;
      el.style.height = "16px";
      break;

    default:
      el = document.createElement("div");
      el.textContent = data?.caption || type;
  }

  // ‚öôÔ∏è Thu·ªôc t√≠nh control
  el.className = "control ctrl-" + type;
  el.dataset.type = type;
  el.dataset.id = data?.id || `${type}_${Date.now()}`;
  el.dataset.caption = data?.caption || type;
  el.dataset.parent = data?.parent || "MainForm";
  el.dataset.style = data?.style || "WS_VISIBLE|WS_CHILD";
  el.dataset.locked = data?.locked || "false";

  // üìè K√≠ch th∆∞·ªõc
  if (!data) {
    if (type === "CheckBox" || type === "RadioButton") {
      el.style.width = "16px";
      el.style.height = "16px";
    } else if (type === "ProgressBar") {
      el.style.width = "150px";
      el.style.height = "16px";
    } else if (type === "ComboBox") {
      el.style.width = "140px";
      el.style.height = "25px";
    } else if (type === "ListBox") {
      el.style.width = "160px";
      el.style.height = "100px";
    } else {
      el.style.width = "120px";
      el.style.height = "30px";
    }
  } else {
    el.style.width = (data.w || 120) + "px";
    el.style.height = (data.h || 30) + "px";
  }

  // üìç T√≠nh to·∫° ƒë·ªô trung t√¢m (0,0)
  const center = 4000;
  let x, y;
  if (data) {
    x = center + data.x;
    y = center + data.y;
  } else {
    const viewX = canvasWrapper.scrollLeft + canvasWrapper.clientWidth / 2;
    const viewY = canvasWrapper.scrollTop + canvasWrapper.clientHeight / 2;
    x = viewX;
    y = viewY;
  }

  el.style.position = "absolute";
  el.style.left = x - parseInt(el.style.width) / 2 + "px";
  el.style.top = y - parseInt(el.style.height) / 2 + "px";

  // üì¶ Th√™m control v√†o canvas
  canvas.appendChild(el);

  // üß© K√©o th·∫£
  makeDraggable(el);

  // üîò Ch·ªçn control v·ª´a th√™m
  selectControl(el);

  // üíæ L∆∞u tr·∫°ng th√°i ƒë·ªÉ Undo
  saveState();

  // üëÅÔ∏è Cu·ªôn camera ƒë·∫øn control v·ª´a t·∫°o
  canvasWrapper.scrollTo({
    left: x - canvasWrapper.clientWidth / 2,
    top: y - canvasWrapper.clientHeight / 2,
    behavior: "smooth"
  });
}



// üéØ Drag
function makeDraggable(ctrl){
  ctrl.onmousedown=e=>{
    if(e.button!==0||lockedDesign)return;
    isDragging=true;offsetX=e.offsetX;offsetY=e.offsetY;
    selectedControl=ctrl;selectControl(ctrl);
    e.stopPropagation();
  };
}
window.onmousemove=e=>{
  if(isDragging&&selectedControl){
    const rect=canvas.getBoundingClientRect();
    const x=e.clientX-rect.left-offsetX;
    const y=e.clientY-rect.top-offsetY;
    selectedControl.style.left=x+"px";
    selectedControl.style.top=y+"px";
    updateProperties(selectedControl);
  }
};
window.onmouseup=()=>{if(isDragging){isDragging=false;saveState();}};

// üß© Property panel
function selectControl(ctrl){
  document.querySelectorAll(".control").forEach(c=>c.classList.remove("selected"));
  ctrl.classList.add("selected");
  selectedControl=ctrl;
  updateProperties(ctrl);
}
function updateProperties(ctrl){
  const id=ctrl.dataset.id,type=ctrl.dataset.type,caption=ctrl.dataset.caption,parent=ctrl.dataset.parent;
  const style=ctrl.dataset.style;
  // üîπ hi·ªÉn th·ªã t·ªça ƒë·ªô quanh t√¢m
  const x=parseInt(ctrl.style.left)-CENTER;
  const y=parseInt(ctrl.style.top)-CENTER;
  const w=parseInt(ctrl.style.width),h=parseInt(ctrl.style.height);

  propertyContent.innerHTML=`
  <div class='property'><label>ID:</label><input id='p_id' value='${id}'></div>
  <div class='property'><label>Lo·∫°i:</label><input value='${type}' disabled></div>
  <div class='property'><label>Caption:</label><input id='p_caption' value='${caption}'></div>
  <div class='property'><label>X:</label><input id='p_x' type='number' value='${x}'></div>
  <div class='property'><label>Y:</label><input id='p_y' type='number' value='${y}'></div>
  <div class='property'><label>R·ªông:</label><input id='p_w' type='number' value='${w}'></div>
  <div class='property'><label>Cao:</label><input id='p_h' type='number' value='${h}'></div>
  <div class='property'><label>Style:</label><input id='p_style' value='${style}' readonly style='cursor:pointer;background:#eee;'></div>
  <div class='property'><label>ParentID:</label><input id='p_parent' value='${parent}'></div>`;

  document.getElementById("p_caption").oninput=e=>{
    ctrl.dataset.caption=e.target.value;ctrl.textContent=e.target.value;
  };
  ["x","y","w","h"].forEach(k=>{
    document.getElementById("p_"+k).oninput=e=>{
      const val=parseInt(e.target.value)||0;
      if(k==="x") ctrl.style.left=(CENTER+val)+"px";
      else if(k==="y") ctrl.style.top=(CENTER+val)+"px";
      else if(k==="w") ctrl.style.width=val+"px";
      else ctrl.style.height=val+"px";
    };
  });
  document.getElementById("p_style").onclick=e=>showStylePopup(ctrl,e.target);
}

// ‚öô Popup ch·ªçn style c√≥ tooltip ti·∫øng Vi·ªát
function showStylePopup(ctrl, input) {
  const type = ctrl.dataset.type;

  // üß† Gi·∫£i th√≠ch ti·∫øng Vi·ªát cho t·ª´ng style
  const explain = {
    WS_VISIBLE: "Hi·ªÉn th·ªã control khi ch·∫°y ch∆∞∆°ng tr√¨nh.",
    WS_CHILD: "L√† control con b√™n trong c·ª≠a s·ªï ch√≠nh.",
    WS_BORDER: "V·∫Ω vi·ªÅn quanh control.",
    WS_TABSTOP: "Cho ph√©p nh·∫≠n focus b·∫±ng ph√≠m Tab.",
    BS_PUSHBUTTON: "Ki·ªÉu n√∫t b·∫•m th√¥ng th∆∞·ªùng.",
    BS_DEFPUSHBUTTON: "N√∫t m·∫∑c ƒë·ªãnh khi nh·∫•n Enter (m√†u xanh).",
    BS_CHECKBOX: "T·∫°o √¥ vu√¥ng ch·ªçn (checkbox).",
    BS_AUTOCHECKBOX: "Checkbox t·ª± ƒë·ªông thay ƒë·ªïi tr·∫°ng th√°i khi click.",
    CBS_DROPDOWNLIST: "Combobox d·∫°ng danh s√°ch th·∫£ xu·ªëng, kh√¥ng cho nh·∫≠p tay.",
    CBS_DROPDOWN: "Combobox c√≥ th·ªÉ nh·∫≠p th√™m vƒÉn b·∫£n.",
    CBS_SIMPLE: "Combobox lu√¥n hi·ªÉn th·ªã danh s√°ch.",
    CBS_SORT: "T·ª± ƒë·ªông s·∫Øp x·∫øp danh s√°ch combobox.",
    LBS_NOTIFY: "G·ª≠i th√¥ng ƒëi·ªáp khi ng∆∞·ªùi d√πng ch·ªçn d√≤ng.",
    LBS_SORT: "S·∫Øp x·∫øp n·ªôi dung listbox theo b·∫£ng ch·ªØ c√°i.",
    LBS_MULTIPLESEL: "Cho ph√©p ch·ªçn nhi·ªÅu d√≤ng (Ctrl + click).",
    LBS_EXTENDEDSEL: "Ch·ªçn nhi·ªÅu d√≤ng b·∫±ng Shift ho·∫∑c Ctrl."
  };

  const ws = ["WS_VISIBLE", "WS_CHILD", "WS_BORDER", "WS_TABSTOP"];
  const bs = ["BS_PUSHBUTTON", "BS_DEFPUSHBUTTON", "BS_CHECKBOX", "BS_AUTOCHECKBOX"];
  const cbs = ["CBS_DROPDOWNLIST", "CBS_DROPDOWN", "CBS_SIMPLE", "CBS_SORT"];
  const lbs = ["LBS_NOTIFY", "LBS_SORT", "LBS_MULTIPLESEL", "LBS_EXTENDEDSEL"];

  let groups = [];
  groups.push({ title: "ü™ü Window Styles", items: ws });
  if (["Button", "CheckBox", "RadioButton"].includes(type))
    groups.push({ title: "üñ± Button Styles", items: bs });
  if (type === "ComboBox") groups.push({ title: "üì¶ ComboBox Styles", items: cbs });
  if (type === "ListBox") groups.push({ title: "üìã ListBox Styles", items: lbs });

  // üß© Render popup
  let html = "";
  groups.forEach(g => {
    html += `<h4>${g.title}</h4>`;
    g.items.forEach(s => {
      const checked = ctrl.dataset.style.includes(s) ? "checked" : "";
      const tip = explain[s] || "Kh√¥ng c√≥ m√¥ t·∫£.";
      html += `<label title="${tip}">
                 <input type='checkbox' value='${s}' ${checked}> ${s}
               </label><br>`;
    });
  });

  stylePopup.innerHTML = html;
  stylePopup.style.left = (input.getBoundingClientRect().left - 10) + "px";
  stylePopup.style.top = (input.getBoundingClientRect().bottom + 4) + "px";
  stylePopup.style.display = "block";

  // ü™Ñ Khi ng∆∞·ªùi d√πng tick ch·ªçn ‚Äî c·∫≠p nh·∫≠t style & giao di·ªán th·∫≠t
  stylePopup.querySelectorAll("input[type=checkbox]").forEach(cb => {
    cb.onchange = () => {
      const selected = [...stylePopup.querySelectorAll("input:checked")].map(x => x.value);
      ctrl.dataset.style = selected.join("|");
      input.value = ctrl.dataset.style;

      // ‚öôÔ∏è √Åp d·ª•ng tr·ª±c ti·∫øp style th·ª±c t·∫ø
      applyVisualStyle(ctrl, selected);
    };
  });

  // ƒë√≥ng popup khi click ra ngo√†i
  document.onclick = (e) => {
    if (!stylePopup.contains(e.target) && e.target !== input)
      stylePopup.style.display = "none";
  };
}
// üé® √Åp d·ª•ng thay ƒë·ªïi giao di·ªán th·∫≠t d·ª±a tr√™n style tick ch·ªçn
function applyVisualStyle(ctrl, selected) {
  const type = ctrl.dataset.type;

  // Reset l·∫°i v·ªÅ m·∫∑c ƒë·ªãnh
  ctrl.disabled = false;
  ctrl.style.border = "";
  ctrl.style.background = "";
  ctrl.style.color = "";
  ctrl.style.fontWeight = "";
  ctrl.removeAttribute("multiple");

  // üîò Button Styles
  if (selected.includes("BS_DEFPUSHBUTTON")) {
    ctrl.style.background = "#0078D7";
    ctrl.style.color = "white";
    ctrl.style.fontWeight = "600";
  }

  // ‚òëÔ∏è CheckBox
  if (selected.includes("BS_CHECKBOX") || selected.includes("BS_AUTOCHECKBOX")) {
    if (ctrl.tagName !== "INPUT" || ctrl.type !== "checkbox") {
      const newEl = document.createElement("input");
      newEl.type = "checkbox";
      newEl.className = ctrl.className;
      newEl.dataset = ctrl.dataset;
      ctrl.replaceWith(newEl);
      selectedControl = newEl;
    }
  }

  // üì¶ ComboBox
  if (type === "ComboBox") {
    if (selected.includes("CBS_DROPDOWNLIST")) {
      ctrl.disabled = true;
    } else if (selected.includes("CBS_SORT")) {
      const opts = [...ctrl.querySelectorAll("option")].map(o => o.textContent).sort();
      ctrl.innerHTML = "";
      opts.forEach(txt => {
        const o = document.createElement("option");
        o.textContent = txt;
        ctrl.appendChild(o);
      });
    }
  }

  // üìã ListBox
  if (type === "ListBox") {
    if (selected.includes("LBS_SORT")) {
      const opts = [...ctrl.querySelectorAll("option")].map(o => o.textContent).sort();
      ctrl.innerHTML = "";
      opts.forEach(txt => {
        const o = document.createElement("option");
        o.textContent = txt;
        ctrl.appendChild(o);
      });
    }
    if (selected.includes("LBS_MULTIPLESEL") || selected.includes("LBS_EXTENDEDSEL")) {
      ctrl.multiple = true;
    } else {
      ctrl.removeAttribute("multiple");
    }
  }
}




canvas.addEventListener("click",e=>{
  const combo=e.target.closest(".ctrl-ComboBox");
  if(combo){
    e.stopPropagation();
    const exist=combo.querySelector(".combo-dropdown");
    if(exist){exist.remove();return;}
    const drop=document.createElement("div");
    drop.className="combo-dropdown";
    drop.style.position="absolute";
    drop.style.left="0";drop.style.top="100%";
    drop.style.width="100%";
    drop.style.background="#fff";
    drop.style.border="1px solid #aaa";
    drop.style.zIndex="9999";
    for(let i=1;i<=5;i++){
      const item=document.createElement("div");
      item.textContent="Item "+i;
      item.style.padding="3px 5px";
      item.style.cursor="pointer";
      item.onmouseenter=()=>item.style.background="#0078D7",item.style.color="#fff";
      item.onmouseleave=()=>item.style.background="",item.style.color="";
      item.onclick=()=>{
        combo.textContent=item.textContent;
        drop.remove();
      };
      drop.appendChild(item);
    }
    combo.appendChild(drop);
  }
});
// üíæ Layout quanh t√¢m 0,0
function getLayout(){
  const arr=[];
  canvas.querySelectorAll(".control").forEach(c=>{
    arr.push({
      id:c.dataset.id,type:c.dataset.type,caption:c.dataset.caption,
      x:parseInt(c.style.left)-CENTER,
      y:parseInt(c.style.top)-CENTER,
      w:parseInt(c.style.width),h:parseInt(c.style.height),
      parent:c.dataset.parent,style:c.dataset.style
    });
  });
  return arr;
}
function setLayout(data){
  canvas.innerHTML='<div id="axisX" class="axis" style="top:4000px;width:8000px;height:1px;left:0;background:red"></div><div id="axisY" class="axis" style="left:4000px;width:1px;height:8000px;top:0;background:red"></div>';
  data.forEach(d=>addControl(d.type,d));
}
function saveState(){undoStack.push(JSON.stringify(getLayout()));if(undoStack.length>MAX_UNDO)undoStack.shift();}
document.getElementById("undoBtn").onclick=()=>{if(undoStack.length<2)return;undoStack.pop();setLayout(JSON.parse(undoStack.at(-1)));};
document.getElementById("clearBtn").onclick=()=>{if(confirm("X√≥a to√†n b·ªô layout?")){canvas.innerHTML="";saveState();}};
document.getElementById("saveBtn").onclick=()=>{const blob=new Blob([JSON.stringify(getLayout(),null,2)],{type:"text/plain"});const a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download="layout_v763.txt";a.click();};
document.getElementById("removeBtn").onclick=()=>{if(selectedControl){selectedControl.remove();selectedControl=null;propertyContent.textContent="Ch·ªçn control ƒë·ªÉ ch·ªânh";saveState();}};
// ======================= N·∫†P LAYOUT (.txt / .json) =======================
document.getElementById("loadBtn").onclick = () => {
  const inp = document.createElement("input");
  inp.type = "file";
  inp.accept = ".txt,.json";

  inp.onchange = (e) => {
    const f = e.target.files[0];
    if (!f) return;
    const r = new FileReader();

    r.onload = (ev) => {
      try {
        const layout = JSON.parse(ev.target.result);
        if (!layout || !layout.controls) {
          alert("‚ùå File kh√¥ng h·ª£p l·ªá ho·∫∑c thi·∫øu ph·∫ßn 'controls'.");
          return;
        }

        // X√≥a control c≈© tr√™n canvas
        document.querySelectorAll(".control").forEach(el => el.remove());

        layout.controls.forEach(c => {
          let el;
          switch (c.type) {
            case "Button":
              el = document.createElement("button");
              el.textContent = c.caption || "Button";
              break;
            case "Edit":
              el = document.createElement("input");
              el.type = "text";
              el.value = c.caption || "";
              break;
            case "Static":
              el = document.createElement("label");
              el.textContent = c.caption || "Static";
              break;
            case "CheckBox":
              el = document.createElement("input");
              el.type = "checkbox";
              el.style.width = "16px";
              el.style.height = "16px";
              break;
            case "RadioButton":
              el = document.createElement("input");
              el.type = "radio";
              el.style.width = "16px";
              el.style.height = "16px";
              break;
            case "ComboBox":
              el = document.createElement("select");
              for (let i = 1; i <= 5; i++) {
                const o = document.createElement("option");
                o.textContent = "Item " + i;
                el.appendChild(o);
              }
              break;
            case "ListBox":
              el = document.createElement("select");
              el.multiple = true;
              for (let i = 1; i <= 10; i++) {
                const o = document.createElement("option");
                o.textContent = "Item " + i;
                el.appendChild(o);
              }
              break;
            case "ProgressBar":
              el = document.createElement("progress");
              el.value = 40;
              el.max = 100;
              el.style.height = "16px";
              break;
            case "GroupBox":
              el = document.createElement("fieldset");
              const lg = document.createElement("legend");
              lg.textContent = c.caption || "GroupBox";
              el.appendChild(lg);
              break;
            default:
              el = document.createElement("div");
              el.textContent = c.caption || c.type;
          }

          // dataset cho export
          el.dataset.type = c.type;
          el.dataset.caption = c.caption || "";
          el.dataset.style = c.style || "";
          el.dataset.id = c.id || "";
          el.style.position = "absolute";
          el.style.left = c.x + "px";
          el.style.top = c.y + "px";
          el.style.width = c.w + "px";
          el.style.height = c.h + "px";

          el.classList.add("control");
          document.getElementById("canvas").appendChild(el);

          // g·∫Øn l·∫°i s·ª± ki·ªán ch·ªçn v√† k√©o th·∫£
          makeElementDraggable(el);
          el.onclick = (ev) => selectControl(el, ev);
        });

        alert("‚úÖ N·∫°p layout th√†nh c√¥ng!");
      } catch (err) {
        alert("‚ùå L·ªói ƒë·ªçc layout: " + err.message);
      }
    };

    r.readAsText(f);
  };

  inp.click();
};
function makeElementDraggable(el) {
  let offsetX = 0, offsetY = 0, startX = 0, startY = 0;
  const canvas = document.getElementById("canvas");

  el.onmousedown = function (e) {
    e.preventDefault();
    startX = e.clientX;
    startY = e.clientY;
    offsetX = parseInt(el.style.left || 0);
    offsetY = parseInt(el.style.top || 0);

    document.onmousemove = dragElement;
    document.onmouseup = stopDrag;
    el.classList.add("dragging");
  };

  function dragElement(e) {
    e.preventDefault();
    const dx = e.clientX - startX;
    const dy = e.clientY - startY;
    el.style.left = offsetX + dx + "px";
    el.style.top = offsetY + dy + "px";
  }

  function stopDrag() {
    document.onmouseup = null;
    document.onmousemove = null;
    el.classList.remove("dragging");
  }
}

// üì§ Xu·∫•t C++ code ƒë·∫πp
document.getElementById("exportBtn").onclick = () => {
  const layout = getLayout();
  const lang = document.getElementById("exportLang").value;
  let out = "";

  if (lang === "cpp") {
    out += `// ========== Generated by Win32 UI Builder Pro v7.7.0 ==========\n`;
    out += `#include <windows.h>\n\n`;
    out += `void CreateUI(HWND hwnd, HINSTANCE hInst){\n`;
    out += `    HFONT hFont = (HFONT)GetStockObject(DEFAULT_GUI_FONT);\n`;
    layout.forEach((c, i) => {
      if (c.type === "MainForm") return;
      out += `\n    // ${c.type}\n`;
      out += `    HWND h${c.id}=CreateWindowW(\n`;
      out += `        L"${c.type}", L"${c.caption}",\n`;
      out += `        ${c.style || "WS_VISIBLE|WS_CHILD"},\n`;
      out += `        ${c.x}, ${c.y}, ${c.w}, ${c.h},\n`;
      out += `        hwnd, (HMENU)${1000 + i}, hInst, NULL);\n`;
      out += `    SendMessage(h${c.id}, WM_SETFONT, (WPARAM)hFont, TRUE);\n`;
    });
    out += `\n}\n`;

  } else if (lang === "c") {
    out += `/* ========== Generated by Win32 UI Builder Pro v7.7.0 ========== */\n`;
    out += `#include <windows.h>\n\n`;
    out += `void CreateUI(HWND hwnd, HINSTANCE hInst){\n`;
    out += `    HFONT hFont = (HFONT)GetStockObject(DEFAULT_GUI_FONT);\n`;
    layout.forEach((c, i) => {
      if (c.type === "MainForm") return;
      out += `\n    // ${c.type}\n`;
      out += `    HWND h${c.id}=CreateWindow(\n`;
      out += `        "${c.type}", "${c.caption}",\n`;
      out += `        ${c.style || "WS_VISIBLE|WS_CHILD"},\n`;
      out += `        ${c.x}, ${c.y}, ${c.w}, ${c.h},\n`;
      out += `        hwnd, (HMENU)${1000 + i}, hInst, NULL);\n`;
      out += `    SendMessage(h${c.id}, WM_SETFONT, (WPARAM)hFont, TRUE);\n`;
    });
    out += `\n}\n`;

  } else if (lang === "python") {
    out += `# ========== Generated by Win32 UI Builder Pro v7.7.0 ==========\n`;
    out += `import tkinter as tk\n\n`;
    out += `def create_ui(root):\n`;
    out += `    font=('Segoe UI', 9)\n`;
    layout.forEach(c => {
      if (c.type === "MainForm") return;
      const name = c.id.replace(/[^a-zA-Z0-9]/g, "_");
      if (c.type === "Button") out += `    ${name}=tk.Button(root,text='${c.caption}',font=font)\n`;
      else if (c.type === "Edit") out += `    ${name}=tk.Entry(root,font=font)\n`;
      else if (c.type === "Static") out += `    ${name}=tk.Label(root,text='${c.caption}',font=font)\n`;
      else if (c.type === "CheckBox") out += `    ${name}=tk.Checkbutton(root,text='${c.caption}',font=font)\n`;
      else if (c.type === "ComboBox") out += `    ${name}=tk.OptionMenu(root, tk.StringVar(), 'Item 1', 'Item 2', 'Item 3')\n`;
      else if (c.type === "ListBox") out += `    ${name}=tk.Listbox(root)\n`;
      else if (c.type === "ProgressBar") out += `    ${name}=tk.Scale(root, from_=0, to=100, orient='horizontal')\n`;
      else out += `    ${name}=tk.Label(root,text='${c.type}',font=font)\n`;
      out += `    ${name}.place(x=${c.x}, y=${c.y}, width=${c.w}, height=${c.h})\n`;
    });
    out += `\nif __name__ == "__main__":\n`;
    out += `    root=tk.Tk()\n`;
    out += `    root.geometry("800x600")\n`;
    out += `    create_ui(root)\n`;
    out += `    root.mainloop()\n`;

  } else if (lang === "json") {
    out = JSON.stringify(layout, null, 2);
  }

  // üßæ Hi·ªÉn th·ªã ra khung code preview
  codePreview.textContent = out;

  // üìÅ T·ª± ƒë·ªông t·∫£i file xu·∫•t v·ªÅ

};


// click ngo√†i canvas b·ªè ch·ªçn
canvas.onclick=e=>{
  if(e.target===canvas){
    selectedControl=null;
    document.querySelectorAll(".control").forEach(c=>c.classList.remove("selected"));
    propertyContent.textContent="Ch·ªçn control ƒë·ªÉ ch·ªânh";
  }
};
</script>

</body>
</html>
